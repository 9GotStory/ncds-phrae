# ระบบติดตาม NCDs จังหวัดแพร่

แอปพลิเคชันนี้เป็นแดชบอร์ดและระบบจัดการข้อมูลโรคไม่ติดต่อเรื้อรัง (NCDs) สำหรับจังหวัดแพร่ ช่วยให้เจ้าหน้าที่สาธารณสุขสามารถติดตามสถานการณ์ภาพรวม วิเคราะห์แนวโน้มเชิงพื้นที่ ระบุพื้นที่เสี่ยง และบริหารจัดการข้อมูลได้แบบเรียลไทม์ผ่านการเชื่อมต่อ Google Sheets/Apps Script  
เวอร์ชันปัจจุบันได้เสริม “วงจรการปรับยอดรายเดือน” เพื่อรองรับสถานการณ์จริง เช่น ผู้ป่วยหายดีหรือบันทึกตัวเลขเกิน พร้อมเก็บประวัติการปรับแยกจากข้อมูลฐาน

## ฟีเจอร์หลัก

- ภาพรวมสถานการณ์ NCDs ทั้งจังหวัด พร้อมสถิติสำคัญ กราฟแนวโน้ม และแผนที่ความร้อนเพื่อวิเคราะห์เชิงพื้นที่
- หน้ารายละเอียดสำหรับเจาะลึกข้อมูลตามอำเภอ ตำบล หมู่บ้าน ช่วงเวลา และกลุ่มเป้าหมาย พร้อมกราฟเปรียบเทียบและสัดส่วน
- ระบบจัดการข้อมูลสำหรับผู้ดูแล: อนุมัติบัญชีผู้ใช้ จัดการสิทธิ์ ดูบันทึกการใช้งาน และบันทึกข้อมูลรายเดือน
- ฟอร์มกรอกข้อมูลสำหรับเจ้าหน้าที่ภาคสนาม รองรับการบันทึกตัวชี้วัดหลายหมวด (Overview, Obesity, Diabetes, Hypertension, Mental, Alcohol, Smoking)
- โมดูล “การปรับยอดรายเดือน” แบบ Wizard: เปรียบเทียบฐานข้อมูลกับตัวเลขใหม่, แสดง diff ต่อหมวด/สถานะ, บังคับบันทึกเหตุผลประกอบ และแสดงประวัติย้อนหลัง
- การยืนยันตัวตนและกำหนดบทบาทผู้ใช้ (admin, officer, viewer) เพื่อควบคุมการเข้าถึงข้อมูล
- วงจรเรียกข้อมูลผ่าน `googleSheetsApi` เพื่อซิงก์กับ Google Sheets และ Google Apps Script

## สถาปัตยกรรมและเทคโนโลยี

- React 18 + TypeScript
- Vite และ @vitejs/plugin-react-swc
- shadcn/ui + Tailwind CSS
- TanStack Query สำหรับจัดการสถานะข้อมูลจาก API
- Chart.js / Recharts สำหรับการแสดงผลกราฟ
- Google Apps Script API (ดูไฟล์ `src/services/googleSheetsApi.ts`)

### การเก็บข้อมูลการปรับยอด

เพื่อลดการแก้ไขข้อมูลดั้งเดิม ระบบจะเก็บ diff แยกไว้ในชีต `Ncd_Adjustments` โดยใช้โครงสร้าง JSON (`Diff_Data`) ซึ่งประกอบด้วย baseline, proposed และ diff ของแต่ละหมวด/สถานะ จากนั้น UI และแดชบอร์ดจะคำนวณ “ยอดหลังปรับ” โดยนำ baseline + diff แสดงเทียบกัน และดึงประวัติทั้งหมดมาปรากฎให้เจ้าหน้าที่ตรวจทาน

> หากไมเกรตข้อมูลเก่ามาใช้รูปแบบใหม่ ให้ลบคอลัมน์ `Category/Status/Net_Change` ออกจากชีต `Ncd_Adjustments` เพื่อป้องกันข้อมูลซ้ำซ้อน

## การเริ่มต้นพัฒนา

1. ติดตั้ง Node.js เวอร์ชัน 18 ขึ้นไป (แนะนำให้ใช้ [nvm](https://github.com/nvm-sh/nvm))
2. ติดตั้ง dependencies

   ```sh
   npm install
   ```

3. รันเซิร์ฟเวอร์พัฒนา

   ```sh
   npm run dev
   ```

   ค่าเริ่มต้นจะให้บริการบน `http://localhost:5173` (หรือพอร์ตที่ Vite แจ้งไว้)

## การตั้งค่าการเชื่อมต่อข้อมูล

- จุดเชื่อมต่อหลักของระบบกำหนดไว้ใน `src/services/googleSheetsApi.ts` (`API_URL`)
- หากต้องการเชื่อมกับชีตหรือสคริปต์อื่น ให้แก้ไข `API_URL` ให้ชี้ไปยัง Google Apps Script ของคุณ
- ตรวจสอบให้ Google Apps Script รองรับเมธอดที่ถูกเรียกในบริการ เช่น การดึง dashboard, บันทึกข้อมูล, ปรับยอดรายเดือน, จัดการผู้ใช้ ฯลฯ
- อัปโหลด `code.gs` (Google Apps Script) เวอร์ชันล่าสุดทุกครั้งเพื่อให้ endpoint `recordNcdAdjustment` รองรับการบันทึก diff และอัปเดตค่า aggregated metrics ที่ส่งกลับมายัง UI

## สคริปต์ที่มีให้ใช้งาน

```sh
npm run dev       # รันโหมดพัฒนา
npm run build     # สร้างไฟล์พร้อมเผยแพร่ (ผลลัพธ์อยู่ที่โฟลเดอร์ dist)
npm run preview   # เปิดดูผลลัพธ์จากไฟล์ build
npm run lint      # ตรวจสอบโค้ดด้วย ESLint
npm run test      # รันทดสอบด้วย Vitest
```

## คู่มือการใช้งานโมดูลปรับยอดรายเดือน

1. ค้นหาข้อมูลที่ต้องการแก้ไขผ่านแบบฟอร์มด้านซ้าย (ระบุกลุ่มเป้าหมาย ปี เดือน พื้นที่ ให้ครบ)
2. กรอกตัวเลขใหม่ในแต่ละหมวด หรือปรับเฉพาะหมวดที่ต้องการ จากนั้นกด “บันทึกเป็นการปรับยอด”
3. ระบบจะแสดงสรุป diff เพื่อยืนยันความถูกต้อง พร้อมช่องให้ใส่เหตุผล (เช่น ผู้ป่วยหายดี)
4. เมื่อยืนยันแล้ว ระบบจะสร้างรายการใหม่ใน `Ncd_Adjustments`, อัปเดตยอดหลังปรับบน UI และเก็บประวัติทุกครั้งในกล่อง “ประวัติการปรับยอด”

> หมายเหตุ: หากต้องการย้อนกลับ ให้สร้างรายการปรับยอดใหม่ด้วย diff ติดลบตามที่ต้องการ (ระบบไม่แก้ไขข้อมูลฐานโดยตรง)

## การเตรียมเผยแพร่ผ่าน GitHub Pages

1. สร้างไฟล์ production ด้วย `npm run build` (ผลลัพธ์ถูกเก็บใน `dist/`)
2. หากใช้ GitHub Pages แบบ project site (`https://<username>.github.io/<repo>`):
   - แก้ไข `vite.config.ts` เพิ่มค่า `base: "/<repo>/"` เพื่อให้ path ถูกต้อง
   - หลัง build ให้ push เนื้อหาใน `dist/` ไปยังสาขา `gh-pages`
3. กำหนดค่า share image ของหน้าเว็บได้ที่ `public/placeholder.svg` (พร้อมใช้งานกับ `<meta property="og:image">` และ `<meta name="twitter:image">`)

แนะนำให้สร้าง workflow GitHub Actions เพื่อ build และ deploy อัตโนมัติทุกครั้งที่ push โค้ดขึ้นสาขาหลัก

## แนวทางการปรับแต่งเพิ่มเติม

- ปรับคอนฟิกเมนู เขตพื้นที่ และตัวเลือกต่าง ๆ ได้จากไฟล์ใน `src/components` และ `src/pages`
- หากมีการเพิ่มเติมหมวดข้อมูลใหม่ อย่าลืมอัปเดตสคีมาใน `src/pages/Admin.tsx` และส่วนที่เกี่ยวข้องในบริการ API
- หากเพิ่มหมวดใหม่ ต้องปรับทั้ง `FORM_STEP_CONFIGS` ใน `Admin.tsx`, สคีมาใน `schema.md`, และฟังก์ชันที่เกี่ยวข้องใน `code.gs` (`createEmptyMetricsTemplate`, `NCD_CATEGORY_DEFINITIONS`)
- ตรวจสอบความปลอดภัยของ API และจัดการสิทธิ์ผู้ใช้งานให้สอดคล้องกับนโยบายของหน่วยงาน

พร้อมแล้วสามารถ commit และ push โค้ดขึ้น GitHub เพื่อเชื่อมต่อกับ GitHub Pages หรือระบบ CI/CD ที่ต้องการได้ทันที
